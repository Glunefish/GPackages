name: Fork-repos

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“ URL (ä¾‹å¦‚: https://github.com/username/repo.git)'
        required: true
        type: string
      target_repo_name:
        description: 'ç›®æ ‡ä»“åº“åç§° (ç•™ç©ºåˆ™ä½¿ç”¨æºä»“åº“åç§°)'
        required: false
        type: string
      pat_token:
        description: 'GitHub Personal Access Token (éœ€è¦æœ‰ repo æƒé™)'
        required: true
        type: string
      source_branch:
        description: 'è¦æŠ“å–çš„åˆ†æ”¯ (ç•™ç©ºåˆ™è‡ªåŠ¨æ£€æµ‹é»˜è®¤åˆ†æ”¯)'
        required: false
        type: string
      target_repo_visibility:
        description: 'ç›®æ ‡ä»“åº“å¯è§æ€§'
        required: false
        default: 'public'
        type: choice
        options:
          - public
          - private

jobs:
  fork-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Extract repo info from URL
        id: repo_info
        run: |
          SOURCE_REPO="${{ github.event.inputs.source_repo }}"
          # ä»Ž URL ä¸­æå– owner å’Œ repo name
          if [[ $SOURCE_REPO =~ https://github.com/([^/]+)/([^/.]+)(\.git)?$ ]]; then
            REPO_OWNER="${BASH_REMATCH[1]}"
            REPO_NAME="${BASH_REMATCH[2]}"
            echo "owner=$REPO_OWNER" >> $GITHUB_OUTPUT
            echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
            echo "æå–ä¿¡æ¯: Owner=$REPO_OWNER, Repo=$REPO_NAME"
          else
            echo "é”™è¯¯: æ— æ³•ä»Ž URL ä¸­æå–ä»“åº“ä¿¡æ¯"
            exit 1
          fi

      - name: Set target repository name
        id: set_target_name
        run: |
          if [ -n "${{ github.event.inputs.target_repo_name }}" ]; then
            TARGET_NAME="${{ github.event.inputs.target_repo_name }}"
          else
            TARGET_NAME="${{ steps.repo_info.outputs.repo_name }}"
          fi
          echo "ç›®æ ‡ä»“åº“åç§°: $TARGET_NAME"
          echo "target_name=$TARGET_NAME" >> $GITHUB_OUTPUT

      - name: Validate inputs
        run: |
          echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
          echo "ç›®æ ‡ä»“åº“å: ${{ steps.set_target_name.outputs.target_name }}"
          echo "æŒ‡å®šåˆ†æ”¯: ${{ github.event.inputs.source_branch || 'æœªæŒ‡å®šï¼Œå°†è‡ªåŠ¨æ£€æµ‹' }}"
          echo "å¯è§æ€§: ${{ github.event.inputs.target_repo_visibility }}"

      - name: Get default branch from source repo
        id: get_branch
        if: github.event.inputs.source_branch == ''
        run: |
          echo "æ­£åœ¨æ£€æµ‹æºä»“åº“çš„é»˜è®¤åˆ†æ”¯..."
          
          # ä½¿ç”¨ GitHub API èŽ·å–ä»“åº“ä¿¡æ¯
          RESPONSE=$(curl -s -H "Authorization: token ${{ github.event.inputs.pat_token }}" \
            "https://api.github.com/repos/${{ steps.repo_info.outputs.owner }}/${{ steps.repo_info.outputs.repo_name }}")
          
          # æå–é»˜è®¤åˆ†æ”¯
          DEFAULT_BRANCH=$(echo "$RESPONSE" | grep -o '"default_branch":"[^"]*' | cut -d'"' -f4)
          
          if [ -n "$DEFAULT_BRANCH" ]; then
            echo "âœ… æ£€æµ‹åˆ°é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
            echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ— æ³•é€šè¿‡ API èŽ·å–é»˜è®¤åˆ†æ”¯ï¼Œå°è¯•å¸¸è§åˆ†æ”¯..."
            # å°è¯•å¸¸è§çš„åˆ†æ”¯å
            echo "branch=master" >> $GITHUB_OUTPUT
          fi

      - name: Set branch variable
        id: set_branch
        run: |
          if [ -n "${{ github.event.inputs.source_branch }}" ]; then
            BRANCH="${{ github.event.inputs.source_branch }}"
            echo "ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„åˆ†æ”¯: $BRANCH"
          else
            BRANCH="${{ steps.get_branch.outputs.branch }}"
            echo "ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹çš„åˆ†æ”¯: $BRANCH"
          fi
          echo "æœ€ç»ˆä½¿ç”¨åˆ†æ”¯: $BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Test branch existence
        id: test_branch
        run: |
          echo "æµ‹è¯•åˆ†æ”¯ ${{ steps.set_branch.outputs.branch }} æ˜¯å¦å­˜åœ¨..."
          
          # ä½¿ç”¨ git ls-remote æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --exit-code --heads ${{ github.event.inputs.source_repo }} ${{ steps.set_branch.outputs.branch }}; then
            echo "âœ… åˆ†æ”¯ ${{ steps.set_branch.outputs.branch }} å­˜åœ¨"
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ åˆ†æ”¯ ${{ steps.set_branch.outputs.branch }} ä¸å­˜åœ¨"
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            
            # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„åˆ†æ”¯
            echo "å¯ç”¨çš„åˆ†æ”¯:"
            git ls-remote --heads ${{ github.event.inputs.source_repo }} | cut -f2 | sed 's|refs/heads/||'
          fi

      - name: Find available branch
        id: find_branch
        if: steps.test_branch.outputs.branch_exists == 'false'
        run: |
          echo "æ­£åœ¨æŸ¥æ‰¾å¯ç”¨çš„åˆ†æ”¯..."
          
          # èŽ·å–æ‰€æœ‰åˆ†æ”¯å¹¶é€‰æ‹©ç¬¬ä¸€ä¸ª
          AVAILABLE_BRANCH=$(git ls-remote --heads ${{ github.event.inputs.source_repo }} | head -1 | cut -f2 | sed 's|refs/heads/||')
          
          if [ -n "$AVAILABLE_BRANCH" ]; then
            echo "âœ… æ‰¾åˆ°å¯ç”¨åˆ†æ”¯: $AVAILABLE_BRANCH"
            echo "branch=$AVAILABLE_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åˆ†æ”¯"
            exit 1
          fi

      - name: Clone source repository (shallow)
        run: |
          echo "æ­£åœ¨å…‹éš†åˆ†æ”¯: ${{ steps.set_branch.outputs.branch }}"
          git clone --depth 1 --branch ${{ steps.set_branch.outputs.branch }} \
            ${{ github.event.inputs.source_repo }} source-repo
          echo "âœ… æºä»“åº“å…‹éš†å®Œæˆ"

      - name: Create new repository
        id: create_repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.event.inputs.pat_token }}
          script: |
            const repoName = '${{ steps.set_target_name.outputs.target_name }}';
            const isPrivate = '${{ github.event.inputs.target_repo_visibility }}' === 'private';
            
            try {
              const response = await github.rest.repos.createForAuthenticatedUser({
                name: repoName,
                description: `ä»Ž ${{ github.event.inputs.source_repo }} è¿ç§»çš„ä»£ç  (åˆ†æ”¯: ${{ steps.set_branch.outputs.branch }})`,
                private: isPrivate,
                auto_init: false
              });
              
              console.log('âœ… ä»“åº“åˆ›å»ºæˆåŠŸ:', response.data.html_url);
              return response.data.clone_url;
              
            } catch (error) {
              if (error.status === 422) {
                // ä»“åº“å·²å­˜åœ¨ï¼ŒèŽ·å–çŽ°æœ‰ä»“åº“
                console.log('ðŸ“ ä»“åº“å·²å­˜åœ¨ï¼Œä½¿ç”¨çŽ°æœ‰ä»“åº“');
                const existingRepo = await github.rest.repos.get({
                  owner: context.repo.owner,
                  repo: repoName
                });
                return existingRepo.data.clone_url;
              }
              console.error('âŒ åˆ›å»ºä»“åº“å¤±è´¥:', error);
              throw error;
            }

      - name: Initialize and push to new repository
        run: |
          cd source-repo
          
          # åˆ é™¤åŽŸæœ‰çš„ Git åŽ†å²
          rm -rf .git
          
          # åˆå§‹åŒ–æ–°çš„ Git ä»“åº“
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # æäº¤åˆå§‹ç‰ˆæœ¬
          git commit -m "åˆå§‹æäº¤: ä»Ž ${{ github.event.inputs.source_repo }} (${{ steps.set_branch.outputs.branch }} åˆ†æ”¯) è¿ç§»"
          
          # ä½¿ç”¨è¾“å…¥çš„ PAT è¿›è¡Œè®¤è¯æŽ¨é€
          git remote add origin https://oauth2:${{ github.event.inputs.pat_token }}@github.com/${{ github.repository_owner }}/${{ steps.set_target_name.outputs.target_name }}.git
          git branch -M ${{ steps.set_branch.outputs.branch }}
          git push -u origin ${{ steps.set_branch.outputs.branch }} --force
          
          echo "âœ… ä»£ç å·²æˆåŠŸæŽ¨é€åˆ°æ–°ä»“åº“"

      - name: Create summary
        run: |
          echo "## ðŸŽ‰ ä»“åº“è¿ç§»å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è¿ç§»è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **æºä»“åº“**: ${{ github.event.inputs.source_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä½¿ç”¨åˆ†æ”¯**: ${{ steps.set_branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›®æ ‡ä»“åº“**: ${{ steps.set_target_name.outputs.target_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯è§æ€§**: ${{ github.event.inputs.target_repo_visibility }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤åŽ†å²**: å·²æ¸…é™¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ–°ä»“åº“ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- ä»“åº“åœ°å€: https://github.com/${{ github.repository_owner }}/${{ steps.set_target_name.outputs.target_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ†æ”¯: ${{ steps.set_branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ è¿ç§»æˆåŠŸå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
