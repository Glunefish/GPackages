# The Workflow By GruntFish & DS.
name: Fetch-repos

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ï¼ˆæ ¼å¼:æ‰€æœ‰è€…/ä»“åº“åï¼‰'
        required: true
        type: string
      source_branch:
        description: 'æºä»“åº“åˆ†æ”¯ï¼ˆç•™ç©ºä½¿ç”¨å…¶é»˜è®¤åˆ†æ”¯ï¼‰'
        required: false
        type: string
      source_path:
        description: 'æºæŒ‡å®šè·¯å¾„ï¼ˆç›®å½•æˆ–æ–‡ä»¶ï¼Œå¯ä¸ºç©ºï¼‰'
        required: false
        type: string
      source_type:
        description: 'åŒæ­¥ç±»å‹'
        required: true
        type: choice
        default: 'auto'
        options:
        - auto
        - file
        - directory
      target_branch:
        description: 'ä¿å­˜åˆ°çš„ç›®æ ‡åˆ†æ”¯ï¼ˆä¸å¯ä¸ºç©ºï¼‰'
        required: true
        type: string
        default: 'Packages'
      target_folder:
        description: 'ä¿å­˜åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ï¼ˆå¯ä»¥ä¸ºç©ºï¼‰'
        required: false
        type: string
      save_to_root:
        description: 'ä¿å­˜åˆ°ç›®æ ‡åˆ†æ”¯æ ¹ç›®å½•ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰'
        required: true
        type: boolean
        default: false
      confirm_replace:
        description: 'ç¡®è®¤æ›¿æ¢ç›®æ ‡åˆ†æ”¯å­˜åœ¨çš„æ–‡ä»¶æˆ–ç›®å½•ï¼'
        required: true
        type: boolean
        default: false
      clean_default_files:
        description: 'æ¸…ç†æºä»“åº“çš„å·¥ä½œæµä»¥åŠé»˜è®¤æ–‡ä»¶ç­‰ï¼'
        required: true
        type: boolean
        default: true

jobs:
  sync-to-current-repo:
    runs-on: ubuntu-latest
    steps:
    - name: è®¾ç½®Gité…ç½®
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    - name: æ£€å‡ºå¹¶å‡†å¤‡ç›®æ ‡åˆ†æ”¯
      run: |
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        if [ -z "$TARGET_BRANCH" ]; then
          echo "é”™è¯¯ï¼šç›®æ ‡åˆ†æ”¯ä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        echo "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
        echo "æ­£åœ¨å°è¯•æ£€å‡ºåˆ†æ”¯ '$TARGET_BRANCH'..."
        if git clone --depth 1 --branch "$TARGET_BRANCH" "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" ./workspace 2>/dev/null; then
          echo "åˆ†æ”¯ '$TARGET_BRANCH' å·²å­˜åœ¨ï¼Œå·²æ£€å‡º"
          cd workspace
        else
          echo "åˆ†æ”¯ '$TARGET_BRANCH' ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å·¥ä½œåŒº"
          git clone --depth 1 "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" ./workspace
          cd workspace
          git checkout --orphan "$TARGET_BRANCH"
          git rm -rf . --quiet 2>/dev/null || true
          git commit --allow-empty -m "åˆå§‹åŒ–å­¤å„¿åˆ†æ”¯ $TARGET_BRANCH"
          echo "å­¤å„¿åˆ†æ”¯ '$TARGET_BRANCH' åœ¨æœ¬åœ°åˆ›å»ºå®Œæˆ"
        fi
    - name: éªŒè¯è¾“å…¥å‚æ•°
      run: |
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        if [ -z "$SOURCE_REPO" ]; then
          echo "é”™è¯¯ï¼šæºä»“åº“åœ°å€ä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        if ! echo "$SOURCE_REPO" | grep -q "/"; then
          echo "é”™è¯¯ï¼šæºä»“åº“æ ¼å¼åº”ä¸º 'æ‰€æœ‰è€…/ä»“åº“å'"
          exit 1
        fi
        echo "è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

    - name: æ‹‰å–å¹¶å¤„ç†æºä»“åº“
      env:
        SOURCE_REPO: ${{ github.event.inputs.source_repo }}
        SOURCE_BRANCH: ${{ github.event.inputs.source_branch }}
        SOURCE_PATH: ${{ github.event.inputs.source_path }}
        SOURCE_TYPE: ${{ github.event.inputs.source_type }}
        TARGET_FOLDER: ${{ github.event.inputs.target_folder }}
        SAVE_TO_ROOT: ${{ github.event.inputs.save_to_root }}
        CONFIRM_REPLACE: ${{ github.event.inputs.confirm_replace }}
      working-directory: ./workspace
      run: |
        set -e
        echo "=== ä¿¡æ¯ç®€è¦ ==="
        echo "æºä»“åº“: $SOURCE_REPO"
        echo "æºåˆ†æ”¯: ${SOURCE_BRANCH:-æœªæŒ‡å®šï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯}"
        echo "æºè·¯å¾„: ${SOURCE_PATH:-æ•´ä¸ªä»“åº“}"
        if [ "$SAVE_TO_ROOT" = "true" ]; then
          final_target_path=""
          echo "ä¿å­˜åˆ°: ç›®æ ‡åˆ†æ”¯æ ¹ç›®å½• (å¿½ç•¥ç›®æ ‡æ–‡ä»¶å¤¹è®¾ç½®)"
        else
          repo_name=$(basename "$SOURCE_REPO")
          if [ -n "$TARGET_FOLDER" ]; then
            base_target_path="$TARGET_FOLDER"
            echo "ç›®æ ‡æ–‡ä»¶å¤¹: $TARGET_FOLDER (ç”¨æˆ·æŒ‡å®š)"
          elif [ -n "$SOURCE_PATH" ]; then
            base_target_path=$(basename "$SOURCE_PATH")
            echo "ç›®æ ‡æ–‡ä»¶å¤¹: $base_target_path (æ¥è‡ªæºè·¯å¾„)"
          else
            base_target_path="$repo_name"
            echo "ç›®æ ‡æ–‡ä»¶å¤¹: $repo_name (è‡ªåŠ¨ä½¿ç”¨ä»“åº“å)"
          fi
          final_target_path="$base_target_path"
          echo "ä¿å­˜åˆ°: $final_target_path"
        fi
        temp_dir=$(mktemp -d)
        echo "ä¸´æ—¶ç›®å½•: $temp_dir"
        echo "å¼€å§‹æ‹‰å–æºä»“åº“..."
        if [ -n "$SOURCE_BRANCH" ]; then
          git clone --depth 1 --branch "$SOURCE_BRANCH" "https://github.com/$SOURCE_REPO.git" "$temp_dir"
        else
          git clone --depth 1 "https://github.com/$SOURCE_REPO.git" "$temp_dir"
        fi
        if [ -n "$SOURCE_PATH" ]; then
          source_item="$temp_dir/$SOURCE_PATH"
          if [ ! -e "$source_item" ]; then
            echo "é”™è¯¯: è·¯å¾„ '$SOURCE_PATH' åœ¨æºä»“åº“ä¸­ä¸å­˜åœ¨"
            exit 1
          fi
        fi
        if [ -n "$final_target_path" ] && [ -e "$final_target_path" ]; then
          if [ "$CONFIRM_REPLACE" = "true" ]; then
            echo "ç¡®è®¤æ›¿æ¢å·²å­˜åœ¨çš„è·¯å¾„: $final_target_path"
            rm -rf "$final_target_path"
          else
            echo "é”™è¯¯: è·¯å¾„ '$final_target_path' å·²å­˜åœ¨ï¼Œä½†æœªç¡®è®¤æ›¿æ¢"
            exit 1
          fi
        fi
        echo "å¼€å§‹å¤„ç†æ–‡ä»¶..."
        if [ -n "$SOURCE_PATH" ]; then
          source_item="$temp_dir/$SOURCE_PATH"
          if [ -n "$final_target_path" ]; then
            mkdir -p "$(dirname "$final_target_path")"
          fi
          
          if [ -d "$source_item" ]; then
            cp -r "$source_item" "$final_target_path"/
          else
            if [ -n "$final_target_path" ]; then
              mkdir -p "$(dirname "$final_target_path")"
            fi
            cp "$source_item" "$final_target_path"/
          fi
        else
          if [ -n "$final_target_path" ]; then
            mkdir -p "$final_target_path"
            if command -v rsync >/dev/null; then
              echo "ä½¿ç”¨ rsync å¤åˆ¶æ–‡ä»¶ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼‰"
              rsync -av "$temp_dir/" "$final_target_path"/
            else
              echo "ä½¿ç”¨ find + cp å¤åˆ¶æ–‡ä»¶ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼‰"
              find "$temp_dir" -mindepth 1 -maxdepth 1 -exec cp -r {} "$final_target_path" \;
            fi
            if [ -d "$final_target_path/.git" ]; then
              echo "åˆ é™¤ .git ç›®å½•é¿å…å­æ¨¡å—è¯†åˆ«"
              rm -rf "$final_target_path/.git"
            fi
            if [ -f "$final_target_path/.gitmodules" ]; then
              echo "åˆ é™¤ .gitmodules æ–‡ä»¶"
              rm -f "$final_target_path/.gitmodules"
            fi
          else
            if command -v rsync >/dev/null; then
              echo "ä½¿ç”¨ rsync å¤åˆ¶æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼Œæ’é™¤ .gitï¼‰"
              rsync -av --exclude='.git' "$temp_dir/" ./
            else
              echo "ä½¿ç”¨ find + cp å¤åˆ¶æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼Œæ’é™¤ .gitï¼‰"
              find "$temp_dir" -mindepth 1 -maxdepth 1 -name ".git" -prune -o -exec cp -r {} . \;
            fi
          fi
        fi
        echo "ä¿®å¤å¯æ‰§è¡Œæ–‡ä»¶æƒé™..."
        echo "æŸ¥æ‰¾è·¯å¾„: $final_target_path"
        find "$final_target_path" -type f \( -name "*.sh" -o -name "*.bash" -o -name "*.py" -o -name "*.pl" -o -name "*.rb" -o -name "*.php" -o -name "*.lua" \) -exec chmod +x {} \; 2>/dev/null || true
        echo "å·²ä¿®å¤è„šæœ¬æ–‡ä»¶æƒé™"
        find "$final_target_path" -type d -name "bin" | while read bin_dir; do
          echo "ä¿®å¤ bin ç›®å½•: $bin_dir"
          find "$bin_dir" -type f -exec chmod +x {} \; 2>/dev/null || true
        done
        find "$final_target_path" -type d \( -path "*/usr/bin" -o -path "*/usr/local/bin" -o -path "*/usr/sbin" -o -path "*/sbin" -o -path "*/opt/bin" \) | while read bin_dir; do
          echo "ä¿®å¤ç³»ç»Ÿ bin ç›®å½•: $bin_dir"
          find "$bin_dir" -type f -exec chmod +x {} \; 2>/dev/null || true
        done
        find "$final_target_path" -type f ! -name "*.*" -exec sh -c '
          file="$1"
          if [ -s "$file" ] && head -n 1 "$file" | grep -q "^#!"; then
            echo "ä¿®å¤è„šæœ¬æƒé™: $file"
            chmod +x "$file"
          fi
        ' _ {} \; 2>/dev/null || true
        echo "æƒé™ä¿®å¤å®Œæˆ"
        echo "=== æ–‡ä»¶å¤„ç†å®Œæˆ ==="
        echo "=== æ‹‰å–çš„æ–‡ä»¶åˆ—è¡¨ ==="
        cd "$temp_dir"
        file_count=$(find . -type f | wc -l)
        dir_structure=$(find . -type d | sort)
        echo "æ‹‰å–çš„æ–‡ä»¶æ•°é‡: $file_count"
        echo "ç›®å½•ç»“æ„:"
        echo "$dir_structure"
        cd - > /dev/null
        echo "===================="
        rm -rf "$temp_dir"
    - name: æ‹‰å–å¹¶å¤„ç†æºä»“åº“
      env:
        SOURCE_REPO: ${{ github.event.inputs.source_repo }}
        SOURCE_BRANCH: ${{ github.event.inputs.source_branch }}
        SOURCE_PATH: ${{ github.event.inputs.source_path }}
        SOURCE_TYPE: ${{ github.event.inputs.source_type }}
        TARGET_FOLDER: ${{ github.event.inputs.target_folder }}
        SAVE_TO_ROOT: ${{ github.event.inputs.save_to_root }}
        CONFIRM_REPLACE: ${{ github.event.inputs.confirm_replace }}
      working-directory: ./workspace
      run: |
        set -e
        echo "=== ä¿¡æ¯ç®€è¦ ==="
        echo "æºä»“åº“: $SOURCE_REPO"
        echo "æºåˆ†æ”¯: ${SOURCE_BRANCH:-æœªæŒ‡å®šï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯}"
        echo "æºè·¯å¾„: ${SOURCE_PATH:-æ•´ä¸ªä»“åº“}"
        if [ "$SAVE_TO_ROOT" = "true" ]; then
          final_target_path=""
          echo "ä¿å­˜åˆ°: ç›®æ ‡åˆ†æ”¯æ ¹ç›®å½• (å¿½ç•¥ç›®æ ‡æ–‡ä»¶å¤¹è®¾ç½®)"
        else
          repo_name=$(basename "$SOURCE_REPO")
          if [ -n "$TARGET_FOLDER" ]; then
            base_target_path="$TARGET_FOLDER"
            echo "ç›®æ ‡æ–‡ä»¶å¤¹: $TARGET_FOLDER (ç”¨æˆ·æŒ‡å®š)"
          elif [ -n "$SOURCE_PATH" ]; then
            base_target_path=$(basename "$SOURCE_PATH")
            echo "ç›®æ ‡æ–‡ä»¶å¤¹: $base_target_path (æ¥è‡ªæºè·¯å¾„)"
          else
            base_target_path="$repo_name"
            echo "ç›®æ ‡æ–‡ä»¶å¤¹: $repo_name (è‡ªåŠ¨ä½¿ç”¨ä»“åº“å)"
          fi
          final_target_path="$base_target_path"
          echo "ä¿å­˜åˆ°: $final_target_path"
        fi
        temp_dir=$(mktemp -d)
        echo "ä¸´æ—¶ç›®å½•: $temp_dir"
        echo "å¼€å§‹æ‹‰å–æºä»“åº“..."
        if [ -n "$SOURCE_BRANCH" ]; then
          git clone --depth 1 --branch "$SOURCE_BRANCH" "https://github.com/$SOURCE_REPO.git" "$temp_dir"
        else
          git clone --depth 1 "https://github.com/$SOURCE_REPO.git" "$temp_dir"
        fi
        if [ -n "$SOURCE_PATH" ]; then
          source_item="$temp_dir/$SOURCE_PATH"
          if [ ! -e "$source_item" ]; then
            echo "é”™è¯¯: è·¯å¾„ '$SOURCE_PATH' åœ¨æºä»“åº“ä¸­ä¸å­˜åœ¨"
            exit 1
          fi
        fi
        if [ -n "$final_target_path" ] && [ -e "$final_target_path" ]; then
          if [ "$CONFIRM_REPLACE" = "true" ]; then
            echo "ç¡®è®¤æ›¿æ¢å·²å­˜åœ¨çš„è·¯å¾„: $final_target_path"
            rm -rf "$final_target_path"
          else
            echo "é”™è¯¯: è·¯å¾„ '$final_target_path' å·²å­˜åœ¨ï¼Œä½†æœªç¡®è®¤æ›¿æ¢"
            exit 1
          fi
        fi
        echo "å¼€å§‹å¤„ç†æ–‡ä»¶..."
        if [ -n "$SOURCE_PATH" ]; then
          source_item="$temp_dir/$SOURCE_PATH"
          if [ -n "$final_target_path" ]; then
            mkdir -p "$(dirname "$final_target_path")"
          fi
          
          if [ -d "$source_item" ]; then
            cp -r "$source_item" "$final_target_path"/
          else
            if [ -n "$final_target_path" ]; then
              mkdir -p "$(dirname "$final_target_path")"
            fi
            cp "$source_item" "$final_target_path"/
          fi
        else
          if [ -n "$final_target_path" ]; then
            mkdir -p "$final_target_path"
            if command -v rsync >/dev/null; then
              echo "ä½¿ç”¨ rsync å¤åˆ¶æ–‡ä»¶ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼‰"
              rsync -av "$temp_dir/" "$final_target_path"/
            else
              echo "ä½¿ç”¨ find + cp å¤åˆ¶æ–‡ä»¶ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼‰"
              find "$temp_dir" -mindepth 1 -maxdepth 1 -exec cp -r {} "$final_target_path" \;
            fi
            if [ -d "$final_target_path/.git" ]; then
              echo "åˆ é™¤ .git ç›®å½•é¿å…å­æ¨¡å—è¯†åˆ«"
              rm -rf "$final_target_path/.git"
            fi
            if [ -f "$final_target_path/.gitmodules" ]; then
              echo "åˆ é™¤ .gitmodules æ–‡ä»¶"
              rm -f "$final_target_path/.gitmodules"
            fi
          else
            if command -v rsync >/dev/null; then
              echo "ä½¿ç”¨ rsync å¤åˆ¶æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼Œæ’é™¤ .gitï¼‰"
              rsync -av --exclude='.git' "$temp_dir/" ./
            else
              echo "ä½¿ç”¨ find + cp å¤åˆ¶æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼Œæ’é™¤ .gitï¼‰"
              find "$temp_dir" -mindepth 1 -maxdepth 1 -name ".git" -prune -o -exec cp -r {} . \;
            fi
          fi
        fi
        echo "ä¿®å¤å¯æ‰§è¡Œæ–‡ä»¶æƒé™..."
        echo "æŸ¥æ‰¾è·¯å¾„: $final_target_path"
        find "$final_target_path" -type f \( -name "*.sh" -o -name "*.bash" -o -name "*.py" -o -name "*.pl" -o -name "*.rb" -o -name "*.php" -o -name "*.lua" \) -exec chmod +x {} \; 2>/dev/null || true
        echo "å·²ä¿®å¤è„šæœ¬æ–‡ä»¶æƒé™"
        find "$final_target_path" -type d -name "bin" | while read bin_dir; do
          echo "ä¿®å¤ bin ç›®å½•: $bin_dir"
          find "$bin_dir" -type f -exec chmod +x {} \; 2>/dev/null || true
        done
        find "$final_target_path" -type d \( -path "*/usr/bin" -o -path "*/usr/local/bin" -o -path "*/usr/sbin" -o -path "*/sbin" -o -path "*/opt/bin" \) | while read bin_dir; do
          echo "ä¿®å¤ç³»ç»Ÿ bin ç›®å½•: $bin_dir"
          find "$bin_dir" -type f -exec chmod +x {} \; 2>/dev/null || true
        done
        find "$final_target_path" -type f ! -name "*.*" -exec sh -c '
          file="$1"
          if [ -s "$file" ] && head -n 1 "$file" | grep -q "^#!"; then
            echo "ä¿®å¤è„šæœ¬æƒé™: $file"
            chmod +x "$file"
          fi
        ' _ {} \; 2>/dev/null || true
        echo "æƒé™ä¿®å¤å®Œæˆ"
        echo "=== æ–‡ä»¶å¤„ç†å®Œæˆ ==="
        echo "=== æ‹‰å–çš„æ–‡ä»¶åˆ—è¡¨ ==="
        cd "$temp_dir"
        file_count=$(find . -type f | wc -l)
        dir_structure=$(find . -type d | sort)
        echo "æ‹‰å–çš„æ–‡ä»¶æ•°é‡: $file_count"
        echo "ç›®å½•ç»“æ„:"
        echo "$dir_structure"
        cd - > /dev/null
        echo "===================="
        rm -rf "$temp_dir"

    - name: æ¸…ç†é»˜è®¤æ–‡ä»¶
      if: ${{ github.event.inputs.clean_default_files == 'true' }}
      working-directory: ./workspace
      run: |
        CURRENT_BRANCH="${{ github.event.inputs.target_branch }}"
        echo "ğŸ§¹ å¼€å§‹æ¸…ç†é»˜è®¤æ–‡ä»¶ (åˆ†æ”¯: $CURRENT_BRANCH)"
        echo "=========================================="
        if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
          echo "ğŸš« å®‰å…¨ä¿æŠ¤ï¼šè·³è¿‡æ¸…ç†main/masteråˆ†æ”¯"
          exit 0
        fi
        SAVE_TO_ROOT="${{ github.event.inputs.save_to_root }}"
        if [ "$SAVE_TO_ROOT" = "true" ]; then
          echo "ğŸ¯ æ¸…ç†æ¨¡å¼: æ ¹ç›®å½•æ¸…ç† (å› ä¸ºè®¾ç½®äº† save_to_root)"
          CLEAN_DIR="."
        else
          TARGET_FOLDER="${{ github.event.inputs.target_folder }}"
          SOURCE_PATH="${{ github.event.inputs.source_path }}"
          SOURCE_REPO="${{ github.event.inputs.source_repo }}"
          repo_name=$(basename "$SOURCE_REPO")
          if [ -n "$TARGET_FOLDER" ]; then
            base_target_path="$TARGET_FOLDER"
          else
            base_target_path="$repo_name"
          fi
          if [ -n "$SOURCE_PATH" ]; then
            folder_name=$(basename "$SOURCE_PATH")
            if [ -n "$base_target_path" ]; then
              CLEAN_DIR="$base_target_path/$folder_name"
            else
              CLEAN_DIR="$folder_name"
            fi
          else
            CLEAN_DIR="$base_target_path"
          fi
          echo "ğŸ¯ æ¸…ç†ç›®å½•: $CLEAN_DIR"
        fi
        echo "æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨: $CLEAN_DIR"
        if [ ! -e "$CLEAN_DIR" ]; then
          echo "âš ï¸ ç›®æ ‡è·¯å¾„ '$CLEAN_DIR' ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†"
          exit 0
        fi
        CLEAN_ITEMS=(
          ".gitignore" 
          "LICENSE"
          "CONTRIBUTING.md"
          "CHANGELOG.md"
          "CODE_OF_CONDUCT.md"
          "docs"
          "examples"
          "test"
          "tests"
          ".github"
        )
        echo "ğŸ“‹ åœ¨ $CLEAN_DIR å†…è®¡åˆ’æ¸…ç†çš„é¡¹ç›®:"
        for item in "${CLEAN_ITEMS[@]}"; do
          item_path="$CLEAN_DIR/$item"
          if [ -e "$item_path" ]; then
            echo "   âœ… $item (å­˜åœ¨)"
          else
            echo "   âŒ $item (ä¸å­˜åœ¨)"
          fi
        done
        echo ""
        echo "ğŸ”§ å¼€å§‹æ¸…ç†è¿‡ç¨‹..."
        echo "------------------------------------------"
        cd "$CLEAN_DIR"
        echo "å½“å‰æ¸…ç†ç›®å½•: $(pwd)"
        if [ -d ".github/workflows" ]; then
          echo "åˆ é™¤ .github/workflows ç›®å½•ï¼ˆè§£å†³æƒé™é—®é¢˜ï¼‰"
          rm -rf ".github/workflows"
        fi
        for file in ".gitignore" "LICENSE" "CONTRIBUTING.md" "CHANGELOG.md" "CODE_OF_CONDUCT.md"; do
          if [ -f "$file" ]; then
            echo "åˆ é™¤æ–‡ä»¶: $file"
            rm -f "$file"
            if [ ! -f "$file" ]; then
              echo "   åˆ é™¤æˆåŠŸ"
            else
              echo "   åˆ é™¤å¤±è´¥"
            fi
          fi
        done
        for dir in "docs" "examples" "test" "tests"; do
          if [ -d "$dir" ]; then
            echo "åˆ é™¤ç›®å½•: $dir/"
            rm -rf "$dir"
            if [ ! -d "$dir" ]; then
              echo "   åˆ é™¤æˆåŠŸ"
            else
              echo "   åˆ é™¤å¤±è´¥"
            fi
          fi
        done
        if [ -d ".github" ]; then
          echo "åˆ é™¤æ•´ä¸ª .github/ ç›®å½•åŠå…¶æ‰€æœ‰å†…å®¹"
          rm -rf ".github"
          if [ ! -d ".github" ]; then
            echo "   .github/ ç›®å½•åˆ é™¤æˆåŠŸ"
          else
            echo "   .github/ ç›®å½•åˆ é™¤å¤±è´¥"
          fi
        else
          echo ".github/ ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€æ¸…ç†"
        fi
        echo "------------------------------------------"
        echo "ğŸ“Š æ¸…ç†å®Œæˆç»Ÿè®¡:"
        REMAINING_COUNT=0
        for item in "${CLEAN_ITEMS[@]}"; do
          if [ -e "$item" ]; then
            echo "   ä»ç„¶å­˜åœ¨: $item"
            REMAINING_COUNT=$((REMAINING_COUNT + 1))
          fi
        done
        echo ""
        if [ $REMAINING_COUNT -eq 0 ]; then
          echo "âœ… æ‰€æœ‰ç›®æ ‡æ–‡ä»¶å·²æ¸…ç†å®Œæˆï¼"
        else
          echo "âš ï¸  è¿˜æœ‰ $REMAINING_COUNT ä¸ªé¡¹ç›®æœªè¢«æ¸…ç†"
        fi
        echo "=== æ¸…ç†åçš„æ–‡ä»¶çŠ¶æ€ ==="
        file_count=$(find . -type f | wc -l)
        dir_structure=$(find . -type d | sort)
        echo "å‰©ä½™æ–‡ä»¶æ•°é‡: $file_count"
        echo "ç›®å½•ç»“æ„:"
        echo "$dir_structure"
        echo "===================="
        cd ..
    - name: æäº¤åˆ°ç›®æ ‡åˆ†æ”¯
      working-directory: ./workspace
      run: |
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_PATH="${{ github.event.inputs.source_path }}"
        git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        if ! git ls-remote --heads origin "$TARGET_BRANCH" | grep -q "$TARGET_BRANCH"; then
          echo "é¦–æ¬¡æ¨é€åˆ†æ”¯ $TARGET_BRANCH åˆ°è¿œç¨‹ï¼ˆåŒ…å«åŒæ­¥çš„æ–‡ä»¶ï¼‰"
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            COMMIT_MSG="æ·»åŠ ä»“åº“: $SOURCE_REPO"
            if [ -n "$SOURCE_PATH" ]; then
              COMMIT_MSG="$COMMIT_MSG (è·¯å¾„: $SOURCE_PATH)"
            fi
            git commit -m "$COMMIT_MSG"
          else
            git commit --allow-empty -m "åˆå§‹åŒ–åˆ†æ”¯ $TARGET_BRANCH"
          fi
          git push origin "HEAD:$TARGET_BRANCH" --force
          echo "åˆ†æ”¯åˆ›å»ºå¹¶æ¨é€å®Œæˆ"
        else
          if [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
            exit 0
          fi
          git add .
          COMMIT_MSG="æ·»åŠ ä»“åº“: $SOURCE_REPO"
          if [ -n "$SOURCE_PATH" ]; then
            COMMIT_MSG="$COMMIT_MSG (è·¯å¾„: $SOURCE_PATH)"
          fi
          git commit -m "$COMMIT_MSG"
          echo "æ¨é€åˆ°åˆ†æ”¯: $TARGET_BRANCH"
          git push origin "HEAD:$TARGET_BRANCH" --force
          echo "âœ… åŒæ­¥å®Œæˆï¼æ–‡ä»¶å·²ä¿å­˜åˆ° $TARGET_BRANCH åˆ†æ”¯"
        fi
    - name: æäº¤åˆ°ç›®æ ‡åˆ†æ”¯
      working-directory: ./workspace
      run: |
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_PATH="${{ github.event.inputs.source_path }}"
        git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        if ! git ls-remote --heads origin "$TARGET_BRANCH" | grep -q "$TARGET_BRANCH"; then
          echo "é¦–æ¬¡æ¨é€åˆ†æ”¯ $TARGET_BRANCH åˆ°è¿œç¨‹ï¼ˆåŒ…å«åŒæ­¥çš„æ–‡ä»¶ï¼‰"
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            COMMIT_MSG="æ·»åŠ ä»“åº“: $SOURCE_REPO"
            if [ -n "$SOURCE_PATH" ]; then
              COMMIT_MSG="$COMMIT_MSG (è·¯å¾„: $SOURCE_PATH)"
            fi
            git commit -m "$COMMIT_MSG"
          else
            git commit --allow-empty -m "åˆå§‹åŒ–åˆ†æ”¯ $TARGET_BRANCH"
          fi
          git push origin "HEAD:$TARGET_BRANCH" --force
          echo "åˆ†æ”¯åˆ›å»ºå¹¶æ¨é€å®Œæˆ"
        else
          if [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
            exit 0
          fi
          git add .
          COMMIT_MSG="æ·»åŠ ä»“åº“: $SOURCE_REPO"
          if [ -n "$SOURCE_PATH" ]; then
            COMMIT_MSG="$COMMIT_MSG (è·¯å¾„: $SOURCE_PATH)"
          fi
          git commit -m "$COMMIT_MSG"
          echo "æ¨é€åˆ°åˆ†æ”¯: $TARGET_BRANCH"
          git push origin "HEAD:$TARGET_BRANCH" --force
          echo "âœ… åŒæ­¥å®Œæˆï¼æ–‡ä»¶å·²ä¿å­˜åˆ° $TARGET_BRANCH åˆ†æ”¯"
        fi
